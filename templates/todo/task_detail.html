{% extends "base.html" %} {% block title %}Task Details - {{ task.title }}{%
endblock %} {% block page_title %}Task Details: {{ task.title }}{% endblock %}
{% block col_width %}11{% endblock %} {% block extra_css %} {{ super() }}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.css"
/>
<style>
  .task-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  .subtask-card {
    transition: all 0.3s ease;
    border-left: 4px solid #007bff;
    margin-bottom: 1rem;
  }

  .subtask-card.completed {
    border-left-color: #28a745;
    opacity: 0.8;
  }

  .subtask-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .timeline-container {
    height: 500px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .progress-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(
      #28a745 0deg,
      #28a745 {{task.completion_percentage * 3.6}}deg,
      #e9ecef {{task.completion_percentage * 3.6}}deg
    );
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .progress-circle::before {
    content: "";
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: white;
    position: absolute;
  }

  .progress-text {
    z-index: 1;
    font-weight: bold;
    color: #333;
  }

  .vis-item.completed {
    background-color: rgba(40, 167, 69, 0.6);
    border-color: #28a745;
  }

  .vis-item.pending {
    background-color: rgba(0, 123, 255, 0.6);
    border-color: #007bff;
  }
</style>
{% endblock %} {% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
{% endblock %} {% block content %}
<!-- Task Header -->
<div class="task-header">
  <div class="row align-items-center">
    <div class="col-md-8">
      <h1 class="mb-2">{{ task.title }}</h1>
      <p class="mb-0 lead">
        {{ task.description or 'No description provided' }}
      </p>
      <small class="text-light"
        >Created: {{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</small
      >
    </div>
    <div class="col-md-4 text-center">
      <div class="progress-circle mx-auto">
        <span class="progress-text"
          >{{ "%.0f"|format(task.completion_percentage) }}%</span
        >
      </div>
      <div class="mt-2">
        <small class="text-light">Completion Progress</small>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="d-flex justify-content-between">
      <a
        href="{{ url_for('todo.todo_index') }}"
        class="btn btn-outline-primary"
      >
        <i class="fas fa-arrow-left"></i> Back to All Tasks
      </a>
      <div>
        <button class="btn btn-success" onclick="addSubtask({{ task.id }})">
          <i class="fas fa-plus"></i> Add Subtask
        </button>
        <button class="btn btn-danger" onclick="deleteTask({{ task.id }})">
          <i class="fas fa-trash"></i> Delete Task
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Timeline Visualization -->
<div class="row mb-4">
  <div class="col-md-12">
    <h4><i class="fas fa-chart-gantt"></i> Task Timeline</h4>
    <div class="timeline-container">
      <div id="visualization"></div>
    </div>
  </div>
</div>

<!-- Task Statistics -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-primary">{{ task.subtasks|length }}</h5>
        <p class="card-text">Total Subtasks</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-success">
          {{ task.subtasks|selectattr('completed')|list|length }}
        </h5>
        <p class="card-text">Completed</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-warning">
          {{ task.subtasks|rejectattr('completed')|list|length }}
        </h5>
        <p class="card-text">Pending</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-info">
          {{ "%.1f"|format(task.total_duration_hours) }}h
        </h5>
        <p class="card-text">Total Time</p>
      </div>
    </div>
  </div>
</div>

<!-- Subtasks List -->
<div class="row">
  <div class="col-md-12">
    <h4><i class="fas fa-tasks"></i> Subtasks ({{ task.subtasks|length }})</h4>
    {% if task.subtasks %} {% for subtask in task.subtasks %}
    <div
      class="card subtask-card {% if subtask.completed %}completed{% endif %}"
    >
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <div class="d-flex align-items-center">
          <input
            type="checkbox"
            class="form-check-input me-2"
            {%
            if
            subtask.completed
            %}checked{%
            endif
            %}
            onchange="toggleSubtask({{ task.id }}, {{ subtask.id }})"
          />
          <h6
            class="mb-0 {% if subtask.completed %}text-decoration-line-through{% endif %}"
          >
            {{ subtask.title }}
          </h6>
        </div>
        <div class="dropdown">
          <button
            class="btn btn-sm btn-outline-secondary dropdown-toggle"
            data-bs-toggle="dropdown"
          >
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <ul class="dropdown-menu">
            <li>
              <a
                class="dropdown-item text-danger"
                href="#"
                onclick="deleteSubtask({{ task.id }}, {{ subtask.id }})"
              >
                <i class="fas fa-trash"></i> Delete
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        <p class="card-text">{{ subtask.description or 'No description' }}</p>
        <div class="row">
          <div class="col-md-6">
            <small class="text-muted">
              <i class="fas fa-clock"></i>
              <strong>Start:</strong> {{ subtask.start_time.strftime('%Y-%m-%d
              %H:%M') }}
            </small>
          </div>
          <div class="col-md-6">
            <small class="text-muted">
              <i class="fas fa-clock"></i>
              <strong>End:</strong> {{ subtask.end_time.strftime('%Y-%m-%d
              %H:%M') }}
            </small>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="fas fa-hourglass-half"></i>
            Duration: {{ "%.1f"|format((subtask.end_time -
            subtask.start_time).total_seconds() / 3600) }} hours
          </small>
        </div>
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="text-center">
      <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">No subtasks yet</h5>
      <p class="text-muted">Add your first subtask to get started!</p>
      <button class="btn btn-primary" onclick="addSubtask({{ task.id }})">
        <i class="fas fa-plus"></i> Add First Subtask
      </button>
    </div>
    {% endif %}
  </div>
</div>

<!-- Subtask Modal -->
<div class="modal fade" id="subtaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus"></i> Add Subtask</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form action="{{ url_for('todo.add_subtask') }}" method="post">
        <input
          type="hidden"
          id="subtask_task_id"
          name="task_id"
          value="{{ task.id }}"
        />
        <div class="modal-body">
          <div class="mb-3">
            <label for="subtask_title" class="form-label">Subtask Title</label>
            <input
              type="text"
              class="form-control"
              id="subtask_title"
              name="title"
              required
            />
          </div>
          <div class="mb-3">
            <label for="subtask_description" class="form-label"
              >Description</label
            >
            <textarea
              class="form-control"
              id="subtask_description"
              name="description"
              rows="2"
            ></textarea>
          </div>
          <div class="row">
            <div class="col-md-6">
              <label for="subtask_start_date" class="form-label"
                >Start Date</label
              >
              <input
                type="date"
                class="form-control"
                id="subtask_start_date"
                name="start_date"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="subtask_start_time" class="form-label"
                >Start Time</label
              >
              <input
                type="time"
                class="form-control"
                id="subtask_start_time"
                name="start_time"
                required
              />
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="subtask_end_date" class="form-label">End Date</label>
              <input
                type="date"
                class="form-control"
                id="subtask_end_date"
                name="end_date"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="subtask_end_time" class="form-label">End Time</label>
              <input
                type="time"
                class="form-control"
                id="subtask_end_time"
                name="end_time"
                required
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Add Subtask</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Initialize timeline
      initializeTimeline();

      // Set default dates
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      document.getElementById('subtask_start_date').value = today.toISOString().split('T')[0];
      document.getElementById('subtask_end_date').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('subtask_start_time').value = '09:00';
      document.getElementById('subtask_end_time').value = '10:00';
  });

  function initializeTimeline() {
      const timelineData = {{ timeline_data|safe }};
      const groups = {{ timeline_groups|safe }};

      if (timelineData.length === 0) {
          document.querySelector('#visualization').innerHTML =
              '<div class="d-flex align-items-center justify-content-center h-100 text-muted">' +
              '<div class="text-center">' +
              '<i class="fas fa-calendar-alt fa-3x mb-3"></i>' +
              '<p>No scheduled subtasks yet</p>' +
              '</div></div>';
          return;
      }

      const items = new vis.DataSet(timelineData);
      const groupsDataSet = new vis.DataSet(groups);

      // Calculate time range to determine appropriate scale
      const dates = timelineData.flatMap(item => [new Date(item.start), new Date(item.end)]);
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      const timeRange = maxDate - minDate;

      // Determine scale based on time range
      let timeAxisOptions = {
          scale: 'hour',
          step: 1
      };

      // If range is more than 7 days, use day scale
      if (timeRange > 7 * 24 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'day',
              step: 1
          };
      }
      // If range is more than 3 days, use 12-hour steps
      else if (timeRange > 3 * 24 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'hour',
              step: 12
          };
      }
      // If range is more than 1 day, use 6-hour steps
      else if (timeRange > 24 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'hour',
              step: 6
          };
      }
      // If range is more than 12 hours, use 3-hour steps
      else if (timeRange > 12 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'hour',
              step: 3
          };
      }
      // If range is more than 6 hours, use 2-hour steps
      else if (timeRange > 6 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'hour',
              step: 2
          };
      }

      const container = document.getElementById('visualization');
      const options = {
          zoomable: true,
          moveable: true,
          stack: true,
          orientation: 'top',
          timeAxis: timeAxisOptions,
          format: {
              minorLabels: {
                  millisecond:'SSS',
                  second:     'ss',
                  minute:     'HH:mm',
                  hour:       'HH:mm',
                  weekday:    'ddd D',
                  day:        'D',
                  week:       'w',
                  month:      'MMM',
                  year:       'YYYY'
              },
              majorLabels: {
                  millisecond:'HH:mm:ss',
                  second:     'D MMMM HH:mm',
                  minute:     'ddd D MMMM',
                  hour:       'ddd D MMMM',
                  weekday:    'MMMM YYYY',
                  day:        'MMMM YYYY',
                  week:       'MMMM YYYY',
                  month:      'YYYY',
                  year:       ''
              }
          },
          margin: {
              item: {
                  horizontal: 15,
                  vertical: 10
              }
          },
          height: '450px',
          min: new Date(minDate.getTime() - 2 * 60 * 60 * 1000), // 2 hours before first item
          max: new Date(maxDate.getTime() + 2 * 60 * 60 * 1000), // 2 hours after last item
          showCurrentTime: true,
          tooltip: {
              followMouse: true,
              overflowMethod: 'cap'
          }
      };

      const timeline = new vis.Timeline(container, items, groupsDataSet, options);

      // Fit timeline to show all items with padding
      timeline.fit({
          animation: {
              duration: 500,
              easingFunction: 'easeInOutQuad'
          }
      });

      // Add responsive zoom behavior
      timeline.on('rangechanged', function() {
          const range = timeline.getWindow();
          const duration = range.end - range.start;

          // Adjust step size based on current zoom level
          let newStep = 1;
          let newScale = 'hour';

          if (duration < 6 * 60 * 60 * 1000) { // Less than 6 hours
              newScale = 'hour';
              newStep = 1;
          } else if (duration < 24 * 60 * 60 * 1000) { // Less than 1 day
              newScale = 'hour';
              newStep = 2;
          } else if (duration < 3 * 24 * 60 * 60 * 1000) { // Less than 3 days
              newScale = 'hour';
              newStep = 6;
          } else if (duration < 7 * 24 * 60 * 60 * 1000) { // Less than 1 week
              newScale = 'hour';
              newStep = 12;
          } else {
              newScale = 'day';
              newStep = 1;
          }

          timeline.setOptions({
              timeAxis: {
                  scale: newScale,
                  step: newStep
              }
          });
      });
  }

  function addSubtask(taskId) {
      const modal = new bootstrap.Modal(document.getElementById('subtaskModal'));
      modal.show();
  }

  function toggleSubtask(taskId, subtaskId) {
      const checkbox = event.target;
      const originalState = !checkbox.checked;
      const subtaskElement = checkbox.closest('.subtask-card');

      checkbox.disabled = true;
      if (subtaskElement) {
          subtaskElement.style.opacity = '0.6';
      }

      fetch(`{{ url_for('todo.toggle_subtask') }}`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              task_id: taskId,
              subtask_id: subtaskId
          })
      })
      .then(response => {
          if (response.ok) {
              return response.json();
          } else {
              throw new Error('Server responded with error');
          }
      })
      .then(data => {
          if (data.success) {
              // Update subtask UI
              if (checkbox.checked) {
                  subtaskElement.classList.add('completed');
                  subtaskElement.querySelector('h6').classList.add('text-decoration-line-through');
              } else {
                  subtaskElement.classList.remove('completed');
                  subtaskElement.querySelector('h6').classList.remove('text-decoration-line-through');
              }

              // Update Progress Circle
              updateTaskProgressCircle(taskId);

              // Update stats
              updateTaskStats(taskId);
          } else {
              throw new Error(data.error || 'Unknown error');
          }
      })
      .catch(error => {
          console.error('Error toggling subtask:', error);
          checkbox.checked = originalState;
          alert('Failed to update subtask. Please try again.');
      })
      .finally(() => {
          checkbox.disabled = false;
          if (subtaskElement) {
              subtaskElement.style.opacity = '1';
          }
      });
  }

  function updateTaskProgressCircle(taskId) {
      fetch(`{{ url_for('todo.get_task_progress', task_id=0) }}`.replace('0', taskId))
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              // Update Progress Circle
              const progressCircle = document.querySelector('.progress-circle');
              const progressText = document.querySelector('.progress-text');

              if (progressCircle) {
                  const percentage = data.completion_percentage;
                  const degrees = percentage * 3.6;
                  progressCircle.style.background = `conic-gradient(#28a745 0deg, #28a745 ${degrees}deg, #e9ecef ${degrees}deg)`;
              }

              if (progressText) {
                  progressText.textContent = `${Math.round(data.completion_percentage)}%`;
              }
          }
      })
      .catch(error => {
          console.error('Error updating progress circle:', error);
      });
  }

  function updateTaskStats(taskId) {
      fetch(`{{ url_for('todo.get_task_progress', task_id=0) }}`.replace('0', taskId))
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              // Update Card Stats
              const completedCard = document.querySelector('.card-title.text-success');
              const pendingCard = document.querySelector('.card-title.text-warning');
              const totalTimeCard = document.querySelector('.card-title.text-info');

              if (completedCard) {
                  completedCard.textContent = data.completed_subtasks;
              }

              if (pendingCard) {
                  pendingCard.textContent = data.total_subtasks - data.completed_subtasks;
              }

              if (totalTimeCard) {
                  totalTimeCard.textContent = `${data.total_duration_hours.toFixed(1)}h`;
              }
          }
      })
      .catch(error => {
          console.error('Error updating stats:', error);
      });
  }
</script>
{% endblock %}
