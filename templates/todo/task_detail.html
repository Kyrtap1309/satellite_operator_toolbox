{% extends "base.html" %} {% block title %}Task Details - {{ task.title }}{%
endblock %} {% block page_title %}Task Details: {{ task.title }}{% endblock %}
{% block col_width %}11{% endblock %} {% block extra_css %} {{ super() }}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.css"
/>
<style>
  .task-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  .subtask-card {
    transition: all 0.3s ease;
    border-left: 4px solid #007bff;
    margin-bottom: 1rem;
  }

  .subtask-card.completed {
    border-left-color: #28a745;
    opacity: 0.8;
  }

  .subtask-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .timeline-container {
    height: 500px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .progress-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(
      #28a745 0deg,
      #28a745 {{task.completion_percentage * 3.6}}deg,
      #e9ecef {{task.completion_percentage * 3.6}}deg
    );
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .progress-circle::before {
    content: "";
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: white;
    position: absolute;
  }

  .progress-text {
    z-index: 1;
    font-weight: bold;
    color: #333;
  }

  .vis-item.completed {
    background-color: rgba(40, 167, 69, 0.6);
    border-color: #28a745;
  }

  .vis-item.pending {
    background-color: rgba(0, 123, 255, 0.6);
    border-color: #007bff;
  }
</style>
{% endblock %} {% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
{% endblock %} {% block content %}
<!-- Task Header -->
<div class="task-header">
  <div class="row align-items-center">
    <div class="col-md-8">
      <h1 class="mb-2">{{ task.title }}</h1>
      <p class="mb-0 lead">
        {{ task.description or 'No description provided' }}
      </p>
      <small class="text-light"
        >Created: {{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</small
      >
    </div>
    <div class="col-md-4 text-center">
      <div class="progress-circle mx-auto">
        <span class="progress-text"
          >{{ "%.0f"|format(task.completion_percentage) }}%</span
        >
      </div>
      <div class="mt-2">
        <small class="text-light">Completion Progress</small>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="d-flex justify-content-between">
      <a
        href="{{ url_for('todo.todo_index') }}"
        class="btn btn-outline-primary"
      >
        <i class="fas fa-arrow-left"></i> Back to All Tasks
      </a>
      <div>
        <button class="btn btn-success" onclick="addSubtask({{ task.id }})">
          <i class="fas fa-plus"></i> Add Subtask
        </button>
        <button class="btn btn-danger" onclick="deleteTask({{ task.id }})">
          <i class="fas fa-trash"></i> Delete Task
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Timeline Visualization -->
<div class="row mb-4">
  <div class="col-md-12">
    <h4><i class="fas fa-chart-gantt"></i> Task Timeline</h4>
    <div class="timeline-container">
      <div id="visualization"></div>
    </div>
  </div>
</div>

<!-- Task Statistics -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-primary">{{ task.subtasks|length }}</h5>
        <p class="card-text">Total Subtasks</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-success">
          {{ task.subtasks|selectattr('completed')|list|length }}
        </h5>
        <p class="card-text">Completed</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-warning">
          {{ task.subtasks|rejectattr('completed')|list|length }}
        </h5>
        <p class="card-text">Pending</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h5 class="card-title text-info">
          {{ "%.1f"|format(task.total_duration_hours) }}h
        </h5>
        <p class="card-text">Total Time</p>
      </div>
    </div>
  </div>
</div>

<!-- Subtasks List -->
<div class="row">
  <div class="col-md-12">
    <h4><i class="fas fa-tasks"></i> Subtasks ({{ task.subtasks|length }})</h4>
    {% if task.subtasks %} {% for subtask in task.subtasks %}
    <div
      class="card subtask-card {% if subtask.completed %}completed{% endif %}"
    >
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <div class="d-flex align-items-center">
          <input
            type="checkbox"
            class="form-check-input me-2"
            {%
            if
            subtask.completed
            %}checked{%
            endif
            %}
            onchange="toggleSubtask({{ task.id }}, {{ subtask.id }})"
          />
          <h6
            class="mb-0 {% if subtask.completed %}text-decoration-line-through{% endif %}"
          >
            {{ subtask.title }}
          </h6>
        </div>
        <div class="dropdown">
          <button
            class="btn btn-sm btn-outline-secondary dropdown-toggle"
            data-bs-toggle="dropdown"
          >
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <ul class="dropdown-menu">
            <li>
              <a
                class="dropdown-item"
                href="#"
                onclick="editSubtask({{ task.id }}, {{ subtask.id }}, '{{ subtask.title }}', '{{ subtask.description }}', {% if subtask.start_time %}'{{ subtask.start_time.strftime('%Y-%m-%d') }}'{% else %}''{% endif %}, {% if subtask.start_time %}'{{ subtask.start_time.strftime('%H:%M') }}'{% else %}''{% endif %}, {% if subtask.end_time %}'{{ subtask.end_time.strftime('%Y-%m-%d') }}'{% else %}''{% endif %}, {% if subtask.end_time %}'{{ subtask.end_time.strftime('%H:%M') }}'{% else %}''{% endif %})"
              >
                <i class="fas fa-edit"></i> Edit
              </a>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a
                class="dropdown-item text-danger"
                href="#"
                onclick="deleteSubtask({{ task.id }}, {{ subtask.id }})"
              >
                <i class="fas fa-trash"></i> Delete
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        <p class="card-text">{{ subtask.description or 'No description' }}</p>
        {% if subtask.start_time and subtask.end_time %}
        <div class="row">
          <div class="col-md-6">
            <small class="text-muted">
              <i class="fas fa-clock"></i>
              <strong>Start:</strong> {{ subtask.start_time.strftime('%Y-%m-%d %H:%M') }}
            </small>
          </div>
          <div class="col-md-6">
            <small class="text-muted">
              <i class="fas fa-clock"></i>
              <strong>End:</strong> {{ subtask.end_time.strftime('%Y-%m-%d %H:%M') }}
            </small>
          </div>
        </div>
        <div class="mt-2">
          <small class="text-muted">
            <i class="fas fa-hourglass-half"></i>
            Duration: {{ "%.1f"|format((subtask.end_time - subtask.start_time).total_seconds() / 3600) }} hours
          </small>
        </div>
        {% else %}
        <div class="mt-2">
          <small class="text-muted">
            <i class="fas fa-calendar-times"></i>
            Not scheduled
          </small>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="text-center">
      <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">No subtasks yet</h5>
      <p class="text-muted">Add your first subtask to get started!</p>
      <button class="btn btn-primary" onclick="addSubtask({{ task.id }})">
        <i class="fas fa-plus"></i> Add First Subtask
      </button>
    </div>
    {% endif %}
  </div>
</div>

<!-- Subtask Modal -->
<div class="modal fade" id="subtaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus"></i> Add Subtask</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form action="{{ url_for('todo.add_subtask') }}" method="post">
        <input
          type="hidden"
          id="subtask_task_id"
          name="task_id"
          value="{{ task.id }}"
        />
        <div class="modal-body">
          <div class="mb-3">
            <label for="subtask_title" class="form-label">Subtask Title</label>
            <input
              type="text"
              class="form-control"
              id="subtask_title"
              name="title"
              required
            />
          </div>
          <div class="mb-3">
            <label for="subtask_description" class="form-label"
              >Description</label
            >
            <textarea
              class="form-control"
              id="subtask_description"
              name="description"
              rows="2"
            ></textarea>
          </div>
          
          <!-- Schedule Toggle -->
          <div class="mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="subtask_scheduled"
                name="scheduled"
                onchange="toggleScheduleFields()"
              />
              <label class="form-check-label" for="subtask_scheduled">
                Schedule this subtask
              </label>
            </div>
          </div>

          <!-- Schedule Fields -->
          <div id="schedule_fields" style="display: none;">
            <div class="row">
              <div class="col-md-6">
                <label for="subtask_start_date" class="form-label"
                  >Start Date</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="subtask_start_date"
                  name="start_date"
                />
              </div>
              <div class="col-md-6">
                <label for="subtask_start_time" class="form-label"
                  >Start Time</label
                >
                <input
                  type="time"
                  class="form-control"
                  id="subtask_start_time"
                  name="start_time"
                />
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6">
                <label for="subtask_end_date" class="form-label">End Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="subtask_end_date"
                  name="end_date"
                />
              </div>
              <div class="col-md-6">
                <label for="subtask_end_time" class="form-label">End Time</label>
                <input
                  type="time"
                  class="form-control"
                  id="subtask_end_time"
                  name="end_time"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Add Subtask</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Subtask Modal -->
<div class="modal fade" id="editSubtaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Subtask</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form action="{{ url_for('todo.edit_subtask') }}" method="post">
        <input
          type="hidden"
          id="edit_subtask_task_id"
          name="task_id"
          value="{{ task.id }}"
        />
        <input
          type="hidden"
          id="edit_subtask_id"
          name="subtask_id"
        />
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_subtask_title" class="form-label">Subtask Title</label>
            <input
              type="text"
              class="form-control"
              id="edit_subtask_title"
              name="title"
              required
            />
          </div>
          <div class="mb-3">
            <label for="edit_subtask_description" class="form-label"
              >Description</label
            >
            <textarea
              class="form-control"
              id="edit_subtask_description"
              name="description"
              rows="2"
            ></textarea>
          </div>
          
          <!-- Schedule Toggle -->
          <div class="mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="edit_subtask_scheduled"
                name="scheduled"
                onchange="toggleEditScheduleFields()"
              />
              <label class="form-check-label" for="edit_subtask_scheduled">
                Schedule this subtask
              </label>
            </div>
          </div>

          <!-- Schedule Fields -->
          <div id="edit_schedule_fields" style="display: none;">
            <div class="row">
              <div class="col-md-6">
                <label for="edit_subtask_start_date" class="form-label"
                  >Start Date</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="edit_subtask_start_date"
                  name="start_date"
                />
              </div>
              <div class="col-md-6">
                <label for="edit_subtask_start_time" class="form-label"
                  >Start Time</label
                >
                <input
                  type="time"
                  class="form-control"
                  id="edit_subtask_start_time"
                  name="start_time"
                />
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6">
                <label for="edit_subtask_end_date" class="form-label">End Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="edit_subtask_end_date"
                  name="end_date"
                />
              </div>
              <div class="col-md-6">
                <label for="edit_subtask_end_time" class="form-label">End Time</label>
                <input
                  type="time"
                  class="form-control"
                  id="edit_subtask_end_time"
                  name="end_time"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Update Subtask</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Initialize timeline
      initializeTimeline();

      // Set default dates
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      document.getElementById('subtask_start_date').value = today.toISOString().split('T')[0];
      document.getElementById('subtask_end_date').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('subtask_start_time').value = '09:00';
      document.getElementById('subtask_end_time').value = '10:00';
  });

  function initializeTimeline() {
      const timelineData = {{ timeline_data|safe }};
      const groups = {{ timeline_groups|safe }};

      if (timelineData.length === 0) {
          document.querySelector('#visualization').innerHTML =
              '<div class="d-flex align-items-center justify-content-center h-100 text-muted">' +
              '<div class="text-center">' +
              '<i class="fas fa-calendar-alt fa-3x mb-3"></i>' +
              '<p>No scheduled subtasks yet</p>' +
              '</div></div>';
          return;
      }

      const items = new vis.DataSet(timelineData);
      const groupsDataSet = new vis.DataSet(groups);

      // Calculate time range to determine appropriate scale
      const dates = timelineData.flatMap(item => [new Date(item.start), new Date(item.end)]);
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      const timeRange = maxDate - minDate;

      // Determine scale based on time range
      let timeAxisOptions = {
          scale: 'hour',
          step: 1
      };

      // If range is more than 7 days, use day scale
      if (timeRange > 7 * 24 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'day',
              step: 1
          };
      }
      // If range is more than 3 days, use 12-hour steps
      else if (timeRange > 3 * 24 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'hour',
              step: 12
          };
      }
      // If range is more than 1 day, use 6-hour steps
      else if (timeRange > 24 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'hour',
              step: 6
          };
      }
      // If range is more than 12 hours, use 3-hour steps
      else if (timeRange > 12 * 60 * 60 * 1000) {
          timeAxisOptions = {
              scale: 'hour',
              step: 3
          };
      }

      const options = {
          editable: false,
          stack: false,
          groupOrder: 'content',
          margin: {
              item: 10,
              axis: 5
          },
          onLoad: function (item, element) {
              // Customize item rendering
              element.style.backgroundColor = item.completed ? 'rgba(40, 167, 69, 0.6)' : 'rgba(0, 123, 255, 0.6)';
              element.style.borderColor = item.completed ? '#28a745' : '#007bff';
          },
          onSelect: function (properties) {
              // Handle item select
              const selectedItem = items.get(properties.items[0]);
              if (selectedItem) {
                  openEditSubtaskModal(selectedItem.id);
              }
          },
          onTimeChange: function (item, newStart, newEnd, options) {
              // Handle item time change
              updateSubtaskTime(item.id, newStart, newEnd);
          },
          onMove: function (item, newStart, newEnd, oldStart, oldEnd, options) {
              // Handle item move
              updateSubtaskTime(item.id, newStart, newEnd);
          },
          onResize: function (item, newStart, newEnd, oldStart, oldEnd, options) {
              // Handle item resize
              updateSubtaskTime(item.id, newStart, newEnd);
          },
          tooltip: {
              followMouse: true,
              template: function (item) {
                  return `<div><strong>${item.title}</strong></div>
                          <div>Start: ${moment(item.start).format('YYYY-MM-DD HH:mm')}</div>
                          <div>End: ${moment(item.end).format('YYYY-MM-DD HH:mm')}</div>`;
              }
          },
          timeAxis: {
              scale: timeAxisOptions.scale,
              step: timeAxisOptions.step,
              format: {
                  minor: {
                      scale: 'hour',
                      step: 1,
                      format: 'HH:mm'
                  },
                  major: {
                      scale: 'day',
                      step: 1,
                      format: 'MMM D'
                  }
              }
          }
      };

      const timeline = new vis.Timeline(document.getElementById('visualization'), items, groupsDataSet, options);

      // Adjust timeline height based on content
      const adjustTimelineHeight = () => {
          const container = document.querySelector('.timeline-container');
          const items = container.querySelectorAll('.vis-item');
          if (items.length > 0) {
              const maxHeight = Array.from(items).reduce((max, item) => {
                  const itemHeight = item.offsetHeight;
                  return Math.max(max, itemHeight);
              }, 0);
              container.style.height = `${maxHeight + 50}px`;
          }
      };

      // Initial adjustment
      adjustTimelineHeight();

      // Re-adjust on window resize
      window.addEventListener('resize', adjustTimelineHeight);
  }

  function toggleSubtask(taskId, subtaskId) {
      const checkbox = event.target;
      const subtaskElement = checkbox.closest('.subtask-card');
      const originalState = checkbox.checked;

      // Optimistically update UI
      if (subtaskElement) {
          subtaskElement.style.opacity = '0.5';
      }

      fetch(`{{ url_for('todo.toggle_subtask') }}`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              task_id: taskId,
              subtask_id: subtaskId
          })
      })
      .then(response => {
          if (response.ok) {
              return response.json();
          } else {
              throw new Error('Server responded with error');
          }
      })
      .then(data => {
          if (data.success) {
              // Update subtask UI
              if (checkbox.checked) {
                  subtaskElement.classList.add('completed');
                  subtaskElement.querySelector('h6').classList.add('text-decoration-line-through');
              } else {
                  subtaskElement.classList.remove('completed');
                  subtaskElement.querySelector('h6').classList.remove('text-decoration-line-through');
              }

              // Update Progress Circle
              updateTaskProgressCircle(taskId);

              // Update stats
              updateTaskStats(taskId);
          } else {
              throw new Error(data.error || 'Unknown error');
          }
      })
      .catch(error => {
          console.error('Error toggling subtask:', error);
          checkbox.checked = originalState;
          alert('Failed to update subtask. Please try again.');
      })
      .finally(() => {
          checkbox.disabled = false;
          if (subtaskElement) {
              subtaskElement.style.opacity = '1';
          }
      });
  }

  function updateTaskProgressCircle(taskId) {
      fetch(`{{ url_for('todo.get_task_progress', task_id=0) }}`.replace('0', taskId))
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              // Update Progress Circle
              const progressCircle = document.querySelector('.progress-circle');
              const progressText = document.querySelector('.progress-text');

              if (progressCircle) {
                  const percentage = data.completion_percentage;
                  const degrees = percentage * 3.6;
                  progressCircle.style.background = `conic-gradient(#28a745 0deg, #28a745 ${degrees}deg, #e9ecef ${degrees}deg)`;
              }

              if (progressText) {
                  progressText.textContent = `${Math.round(data.completion_percentage)}%`;
              }
          }
      })
      .catch(error => {
          console.error('Error updating progress circle:', error);
      });
  }

  function updateTaskStats(taskId) {
      fetch(`{{ url_for('todo.get_task_progress', task_id=0) }}`.replace('0', taskId))
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              // Update Card Stats
              const completedCard = document.querySelector('.card-title.text-success');
              const pendingCard = document.querySelector('.card-title.text-warning');
              const totalTimeCard = document.querySelector('.card-title.text-info');

              if (completedCard) {
                  completedCard.textContent = data.completed_subtasks;
              }

              if (pendingCard) {
                  pendingCard.textContent = data.total_subtasks - data.completed_subtasks;
              }

              if (totalTimeCard) {
                  totalTimeCard.textContent = `${data.total_duration_hours.toFixed(1)}h`;
              }
          }
      })
      .catch(error => {
          console.error('Error updating stats:', error);
      });
  }

  function toggleScheduleFields() {
      const checkbox = document.getElementById('subtask_scheduled');
      const fields = document.getElementById('schedule_fields');
      
      if (checkbox.checked) {
          fields.style.display = 'block';
          // Set default values
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          document.getElementById('subtask_start_date').value = today.toISOString().split('T')[0];
          document.getElementById('subtask_end_date').value = tomorrow.toISOString().split('T')[0];
          document.getElementById('subtask_start_time').value = '09:00';
          document.getElementById('subtask_end_time').value = '10:00';
      } else {
          fields.style.display = 'none';
      }
  }

  function toggleEditScheduleFields() {
      const checkbox = document.getElementById('edit_subtask_scheduled');
      const fields = document.getElementById('edit_schedule_fields');
      
      fields.style.display = checkbox.checked ? 'block' : 'none';
  }

  function editSubtask(taskId, subtaskId, title, description, startDate, startTime, endDate, endTime) {
      // Fill the form with current values
      document.getElementById('edit_subtask_id').value = subtaskId;
      document.getElementById('edit_subtask_title').value = title;
      document.getElementById('edit_subtask_description').value = description;
      
      const hasSchedule = startDate && startTime && endDate && endTime;
      document.getElementById('edit_subtask_scheduled').checked = hasSchedule;
      
      if (hasSchedule) {
          document.getElementById('edit_subtask_start_date').value = startDate;
          document.getElementById('edit_subtask_start_time').value = startTime;
          document.getElementById('edit_subtask_end_date').value = endDate;
          document.getElementById('edit_subtask_end_time').value = endTime;
          document.getElementById('edit_schedule_fields').style.display = 'block';
      } else {
          document.getElementById('edit_schedule_fields').style.display = 'none';
      }
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('editSubtaskModal'));
      modal.show();
  }

  function addSubtask(taskId) {
      // Clear the form
      document.getElementById('subtask_title').value = '';
      document.getElementById('subtask_description').value = '';
      
      // Set default dates and times
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      document.getElementById('subtask_start_date').value = today.toISOString().split('T')[0];
      document.getElementById('subtask_end_date').value = tomorrow.toISOString().split('T')[0];
      document.getElementById('subtask_start_time').value = '09:00';
      document.getElementById('subtask_end_time').value = '10:00';
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('subtaskModal'));
      modal.show();
  }

  function deleteTask(taskId) {
      if (confirm('Are you sure you want to delete this task and all its subtasks?')) {
          fetch(`{{ url_for('todo.delete_task') }}`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({task_id: taskId})
          }).then(response => {
              if (response.ok) {
                  // Redirect to todo index after successful deletion
                  window.location.href = "{{ url_for('todo.todo_index') }}";
              } else {
                  alert('Failed to delete task. Please try again.');
              }
          }).catch(error => {
              console.error('Error deleting task:', error);
              alert('Failed to delete task. Please try again.');
          });
      }
  }

  function deleteSubtask(taskId, subtaskId) {
      if (confirm('Are you sure you want to delete this subtask?')) {
          fetch(`{{ url_for('todo.delete_subtask') }}`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  task_id: taskId,
                  subtask_id: subtaskId
              })
          }).then(response => {
              if (response.ok) {
                  location.reload();
              } else {
                  alert('Failed to delete subtask. Please try again.');
              }
          }).catch(error => {
              console.error('Error deleting subtask:', error);
              alert('Failed to delete subtask. Please try again.');
          });
      }
  }
</script>
{% endblock %}
