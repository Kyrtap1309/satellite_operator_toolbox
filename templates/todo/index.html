{% extends "base.html" %} {% block title %}TODO List - Task Manager{% endblock
%} {% block page_title %}TODO List - Task Manager{% endblock %} {% block
col_width %}11{% endblock %} {% block extra_css %} {{ super() }}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.css"
/>
<style>
  .task-card {
    transition: all 0.3s ease;
    border-left: 4px solid #007bff;
  }

  .task-card.completed {
    border-left-color: #28a745;
    opacity: 0.8;
  }

  .task-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .subtask-item {
    border-left: 2px solid #dee2e6;
    margin-left: 1rem;
    padding-left: 1rem;
    margin-bottom: 0.5rem;
  }

  .subtask-item.completed {
    border-left-color: #28a745;
    text-decoration: line-through;
    opacity: 0.7;
  }

  .timeline-container {
    height: auto; /* Changed from fixed 400px */
    min-height: 200px;
    max-height: 800px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    position: relative;
  }

  #visualization {
    height: 100%;
    overflow-y: auto; /* Enable vertical scrolling inside vis container */
  }

  .timeline-resize-handle {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 20px;
    height: 20px;
    background: linear-gradient(
      -45deg,
      transparent 30%,
      #ccc 30%,
      #ccc 40%,
      transparent 40%,
      transparent 60%,
      #ccc 60%,
      #ccc 70%,
      transparent 70%
    );
    cursor: se-resize;
    z-index: 10;
  }

  .timeline-resize-handle:hover {
    background: linear-gradient(
      -45deg,
      transparent 30%,
      #999 30%,
      #999 40%,
      transparent 40%,
      transparent 60%,
      #999 60%,
      #999 70%,
      transparent 70%
    );
  }

  .progress-bar-container {
    height: 20px;
    background-color: #f8f9fa;
    border-radius: 10px;
    overflow: hidden;
  }

  .add-task-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    z-index: 1000;
  }

  .draggable-task {
    cursor: move;
    transition: all 0.3s ease;
  }

  .draggable-task:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .draggable-task.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
  }

  .task-column.drag-over {
    background-color: rgba(0, 123, 255, 0.1);
    border-radius: 8px;
  }

  .drag-handle {
    cursor: grab;
  }

  .drag-handle:active {
    cursor: grabbing;
  }

  .sortable-ghost {
    opacity: 0.4;
  }

  .sortable-chosen {
    transform: scale(1.05);
  }

  .toggle-subtasks-btn:hover {
    text-decoration: underline !important;
  }

  .subtasks-list {
    transition: all 0.3s ease;
  }

  .hidden-subtask {
    transition: opacity 0.3s ease;
  }
</style>
{% endblock %} {% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.0/dist/vis-timeline-graph2d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %} {% block content %}
<!-- Timeline Visualization -->
<div class="row mb-4">
  <div class="col-md-12">
    <h4><i class="fas fa-chart-line"></i> Tasks Timeline</h4>
    <div class="timeline-container" id="timeline-container">
      <div id="visualization"></div>
      <div class="timeline-resize-handle" id="timeline-resize-handle"></div>
    </div>
  </div>
</div>

<!-- Tasks Overview -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4><i class="fas fa-tasks"></i> All Tasks</h4>
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#newTaskModal"
      >
        <i class="fas fa-plus"></i> New Task
      </button>
    </div>
  </div>
</div>

<!-- Tasks List -->
<div class="row" id="tasks-container">
  {% for task in tasks %}
  <div class="col-md-6 col-lg-4 mb-4 task-column" data-task-id="{{ task.id }}">
    <div
      class="card task-card {% if task.completed %}completed{% endif %} draggable-task"
      data-task-id="{{ task.id }}"
    >
      <div
        class="card-header d-flex justify-content-between align-items-center drag-handle"
      >
        <h6 class="mb-0">
          <i class="fas fa-grip-vertical text-muted me-2"></i>
          {{ task.title }}
        </h6>
        <div class="dropdown">
          <button
            class="btn btn-sm btn-outline-secondary dropdown-toggle"
            data-bs-toggle="dropdown"
          >
            <i class="fas fa-ellipsis-v"></i>
          </button>
          <ul class="dropdown-menu">
            <li>
              <a
                class="dropdown-item"
                href="{{ url_for('todo.task_details', task_id=task.id) }}"
              >
                <i class="fas fa-eye"></i> View Details
              </a>
            </li>
            <li>
              <a
                class="dropdown-item"
                href="#"
                onclick="addSubtask({{ task.id }})"
              >
                <i class="fas fa-plus"></i> Add Subtask
              </a>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a
                class="dropdown-item text-danger"
                href="#"
                onclick="deleteTask({{ task.id }})"
              >
                <i class="fas fa-trash"></i> Delete Task
              </a>
            </li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        <p class="card-text small">{{ task.description }}</p>

        <!-- Progress Bar -->
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>Progress</small>
            <small class="progress-text"
              >{{ "%.0f"|format(task.completion_percentage) }}%</small
            >
          </div>
          <div class="progress-bar-container">
            <div
              class="progress-bar bg-success"
              style="width: {{ task.completion_percentage }}%; height: 100%;"
            ></div>
          </div>
        </div>

        <!-- Subtasks -->
        <div class="subtasks">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted subtask-counter"
              >Subtasks ({{ task.subtasks|length }}):</small
            >
            {% if task.subtasks|length > 3 %}
            <button
              class="btn btn-link btn-sm p-0 text-decoration-none toggle-subtasks-btn"
              onclick="toggleSubtasks({{ task.id }})"
              data-task-id="{{ task.id }}"
            >
              <small class="text-primary">
                <i class="fas fa-chevron-down"></i> Show all
              </small>
            </button>
            {% endif %}
          </div>

          <div class="subtasks-list" data-task-id="{{ task.id }}">
            {% for subtask in task.subtasks %}
            <div
              class="subtask-item {% if subtask.completed %}completed{% endif %} {% if loop.index > 3 %}hidden-subtask d-none{% endif %}"
            >
              <div class="d-flex justify-content-between align-items-center">
                <span class="small">{{ subtask.title }}</span>
                <input
                  type="checkbox"
                  class="form-check-input"
                  {%
                  if
                  subtask.completed
                  %}checked{%
                  endif
                  %}
                  onchange="toggleSubtask({{ task.id }}, {{ subtask.id }})"
                />
              </div>
              {% if subtask.start_time and subtask.end_time %}
              <div class="small text-muted">
                {{ subtask.start_time.strftime('%Y-%m-%d %H:%M') }} - {{
                subtask.end_time.strftime('%Y-%m-%d %H:%M') }}
              </div>
              {% else %}
              <div class="small text-muted">Not scheduled</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="mt-3">
          <small class="text-muted total-time">
            Total time: {{ "%.1f"|format(task.total_duration_hours) }} hours
          </small>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="col-md-12">
    <div class="text-center">
      <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">No tasks yet</h5>
      <p class="text-muted">Create your first task to get started!</p>
      <button
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#newTaskModal"
      >
        <i class="fas fa-plus"></i> Create First Task
      </button>
    </div>
  </div>
  {% endfor %}
</div>

<!-- New Task Modal -->
<div class="modal fade" id="newTaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus"></i> New Task</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form action="{{ url_for('todo.create_task') }}" method="post">
        <div class="modal-body">
          <div class="mb-3">
            <label for="task_title" class="form-label">Task Title</label>
            <input
              type="text"
              class="form-control"
              id="task_title"
              name="title"
              required
            />
          </div>
          <div class="mb-3">
            <label for="task_description" class="form-label">Description</label>
            <textarea
              class="form-control"
              id="task_description"
              name="description"
              rows="3"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Subtask Modal -->
<div class="modal fade" id="subtaskModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-plus"></i> Add Subtask</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form action="{{ url_for('todo.add_subtask') }}" method="post">
        <input type="hidden" id="subtask_task_id" name="task_id" />
        <div class="modal-body">
          <div class="mb-3">
            <label for="subtask_title" class="form-label">Subtask Title</label>
            <input
              type="text"
              class="form-control"
              id="subtask_title"
              name="title"
              required
            />
          </div>
          <div class="mb-3">
            <label for="subtask_description" class="form-label"
              >Description</label
            >
            <textarea
              class="form-control"
              id="subtask_description"
              name="description"
              rows="2"
            ></textarea>
          </div>
          <div class="row">
            <div class="col-md-6">
              <label for="subtask_start_date" class="form-label"
                >Start Date</label
              >
              <input
                type="date"
                class="form-control"
                id="subtask_start_date"
                name="start_date"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="subtask_start_time" class="form-label"
                >Start Time</label
              >
              <input
                type="time"
                class="form-control"
                id="subtask_start_time"
                name="start_time"
                required
              />
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="subtask_end_date" class="form-label">End Date</label>
              <input
                type="date"
                class="form-control"
                id="subtask_end_date"
                name="end_date"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="subtask_end_time" class="form-label">End Time</label>
              <input
                type="time"
                class="form-control"
                id="subtask_end_time"
                name="end_time"
                required
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Add Subtask</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Floating Add Button -->
<button
  class="btn btn-primary add-task-btn"
  data-bs-toggle="modal"
  data-bs-target="#newTaskModal"
>
  <i class="fas fa-plus"></i>
</button>
{% endblock %} {% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize timeline
        initializeTimeline();

        // Initialize drag & drop
        initializeSortable();

        // Initialize timeline resizer
        initializeTimelineResizer();

        // Set default dates
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        document.getElementById('subtask_start_date').value = today.toISOString().split('T')[0];
        document.getElementById('subtask_end_date').value = tomorrow.toISOString().split('T')[0];
        document.getElementById('subtask_start_time').value = '09:00';
        document.getElementById('subtask_end_time').value = '10:00';
    });

    function initializeTimeline() {
      const timelineData = {{ timeline_data|safe }};
      const groups = {{ timeline_groups|safe }};

      if (timelineData.length === 0) {
          document.querySelector('.timeline-container').innerHTML =
              '<div class="d-flex align-items-center justify-content-center h-100 text-muted">' +
              '<div class="text-center">' +
              '<i class="fas fa-calendar-alt fa-3x mb-3"></i>' +
              '<p>No scheduled subtasks yet</p>' +
              '</div></div>' +
              '<div class="timeline-resize-handle" id="timeline-resize-handle"></div>';

          // Re-initialize resizer if timeline is empty
          initializeTimelineResizer();
          return;
      }

      const items = new vis.DataSet(timelineData);
      const groupsDataSet = new vis.DataSet(groups);

      // Calculate time range to determine appropriate scale
      const dates = timelineData.flatMap(item => [new Date(item.start), new Date(item.end)]);
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      const container = document.getElementById('visualization');

      // Calculate proper height based on number of groups
      const numberOfGroups = groups.length;
      const minHeight = 200;
      const groupHeight = 50; // Height per group/row
      const calculatedHeight = Math.max(minHeight, numberOfGroups * groupHeight + 100);

      // Set container height
      const timelineContainer = document.getElementById('timeline-container');
      timelineContainer.style.height = calculatedHeight + 'px';

      const options = {
          zoomable: true,
          moveable: true,
          stack: false, // Important: disable stacking to show all rows
          orientation: 'top',
          showCurrentTime: true,
          groupOrder: 'id', // Ensure consistent ordering
          // Force UTC time zone
          moment: function(date) {
              return moment.utc(date);
          },
          format: {
              minorLabels: function(date, scale, step) {
                  // Use UTC formatting
                  if (scale === 'minute' || scale === 'hour') return moment.utc(date).format('HH:mm');
                  if (scale === 'day') return moment.utc(date).format('DD');
                  if (scale === 'month') return moment.utc(date).format('MMM');
                  return moment.utc(date).format('YYYY');
              },
              majorLabels: function(date, scale, step) {
                  // Use UTC formatting with UTC label
                  if (scale === 'minute' || scale === 'hour') return moment.utc(date).format('ddd DD/MM UTC');
                  if (scale === 'day') return moment.utc(date).format('MMMM YYYY UTC');
                  if (scale === 'month') return moment.utc(date).format('YYYY UTC');
                  return '';
              }
          },
          margin: {
              item: {
                  horizontal: 10,
                  vertical: 5
              }
          },
          height: '100%',
          min: new Date(minDate.getTime() - 60 * 60 * 1000),
          max: new Date(maxDate.getTime() + 60 * 60 * 1000),
          zoomMin: 1000 * 60 * 15,
          zoomMax: 1000 * 60 * 60 * 24 * 365 * 2,
          verticalScroll: true, // Enable vertical scrolling
          maxHeight: '100%', // Use full container height
          tooltip: {
              followMouse: true,
              template: function (item) {
                  const startTime = moment.utc(item.start).format('YYYY-MM-DD HH:mm');
                  const endTime = moment.utc(item.end).format('YYYY-MM-DD HH:mm');
                  const duration = moment.utc(item.end).diff(moment.utc(item.start), 'hours', true).toFixed(1);

                  return `<div style="padding: 8px;">
                              <strong>${item.content}</strong><br/>
                              ${item.title ? item.title.split(' - ')[1] + '<br/>' : ''}
                              <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                  <div><i class="fas fa-clock"></i> Start: ${startTime} UTC</div>
                                  <div><i class="fas fa-clock"></i> End: ${endTime} UTC</div>
                                  <div><i class="fas fa-hourglass-half"></i> Duration: ${duration}h</div>
                              </div>
                          </div>`;
              }
          },
      };

      window.timeline = new vis.Timeline(container, items, groupsDataSet, options);

      // Set current time to UTC
      window.timeline.setCurrentTime(moment.utc().toDate());

      // Force redraw to ensure all groups are visible
      setTimeout(() => {
          window.timeline.redraw();
      }, 100);
  }

  function initializeTimelineResizer() {
      const container = document.getElementById('timeline-container');
      const handle = document.getElementById('timeline-resize-handle');
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;

      handle.addEventListener('mousedown', function(e) {
          isResizing = true;
          startY = e.clientY;
          startHeight = parseInt(document.defaultView.getComputedStyle(container).height, 10);
          document.addEventListener('mousemove', doResize);
          document.addEventListener('mouseup', stopResize);
          e.preventDefault();
      });

      function doResize(e) {
          if (!isResizing) return;

          const newHeight = startHeight + (e.clientY - startY);
          const minHeight = 200;
          const maxHeight = window.innerHeight - 200; // Max to screen height minus some margin

          if (newHeight >= minHeight && newHeight <= maxHeight) {
              container.style.height = newHeight + 'px';

              // Redraw timeline to fit new container size
              if (window.timeline) {
                  setTimeout(() => {
                      window.timeline.redraw();
                  }, 10);
              }
          }
      }

      function stopResize() {
          isResizing = false;
          document.removeEventListener('mousemove', doResize);
          document.removeEventListener('mouseup', stopResize);
      }
    }

    function initializeSortable() {
        const tasksContainer = document.getElementById('tasks-container');

        new Sortable(tasksContainer, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            handle: '.drag-handle',
            onEnd: function(evt) {
                // Get new order of task IDs
                const taskIds = Array.from(tasksContainer.children).map(el =>
                    parseInt(el.getAttribute('data-task-id'))
                );

                // Send new order to server
                fetch(`{{ url_for('todo.reorder_tasks') }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({task_ids: taskIds})
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to reorder tasks');
                        // Optionally reload page on error
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error reordering tasks:', error);
                    // Optionally reload page on error
                    location.reload();
                });
            }
        });
    }

    function addSubtask(taskId) {
        document.getElementById('subtask_task_id').value = taskId;
        const modal = new bootstrap.Modal(document.getElementById('subtaskModal'));
        modal.show();
    }

    function toggleSubtask(taskId, subtaskId) {
        const checkbox = event.target;
        const originalState = !checkbox.checked;
        const subtaskElement = checkbox.closest('.subtask-item');

        checkbox.disabled = true;
        subtaskElement.style.opacity = '0.6';

        fetch(`{{ url_for('todo.toggle_subtask') }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task_id: taskId,
                subtask_id: subtaskId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (checkbox.checked) {
                    subtaskElement.classList.add('completed');
                } else {
                    subtaskElement.classList.remove('completed');
                }

                updateTaskProgress(taskId);
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            checkbox.checked = originalState;
            alert('Failed to update subtask. Please try again.');
        })
        .finally(() => {
            checkbox.disabled = false;
            subtaskElement.style.opacity = '1';
        });
    }

    function updateTaskProgress(taskId) {
        fetch(`{{ url_for('todo.get_task_progress', task_id=0) }}`.replace('0', taskId))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Find task card
                const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                if (!taskCard) return;

                // Update progress bar
                const progressBar = taskCard.querySelector('.progress-bar');
                const progressText = taskCard.querySelector('.progress-text');

                if (progressBar) {
                    progressBar.style.width = `${data.completion_percentage}%`;
                }

                if (progressText) {
                    progressText.textContent = `${Math.round(data.completion_percentage)}%`;
                }

                // Update card header counters if they exist
                const subtaskCounter = taskCard.querySelector('.subtask-counter');
                if (subtaskCounter) {
                    subtaskCounter.textContent = `Subtasks (${data.total_subtasks})`;
                }

                // Update toal time
                const totalTime = taskCard.querySelector('.total-time');
                if (totalTime) {
                    totalTime.textContent = `Total time: ${data.total_duration_hours.toFixed(1)} hours`;
                }

                // Add/remove completed class from card if task is totally done
                if (data.completion_percentage === 100) {
                    taskCard.classList.add('completed');
                } else {
                    taskCard.classList.remove('completed');
                }
            }
        })
        .catch(error => {
            console.error('Error updating progress:', error);
        });
    }

    function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task and all its subtasks?')) {
            fetch(`{{ url_for('todo.delete_task') }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({task_id: taskId})
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    }

    function toggleSubtasks(taskId) {
        const subtasksList = document.querySelector(`.subtasks-list[data-task-id="${taskId}"]`);
        const toggleBtn = document.querySelector(`.toggle-subtasks-btn[data-task-id="${taskId}"]`);
        const hiddenSubtasks = subtasksList.querySelectorAll('.hidden-subtask');

        const isExpanded = !hiddenSubtasks[0].classList.contains('d-none');

        hiddenSubtasks.forEach(subtask => {
            if (isExpanded) {
                subtask.classList.add('d-none');
            } else {
                subtask.classList.remove('d-none');
            }
        });

        // Update button text and icon
        const icon = toggleBtn.querySelector('i');
        const text = toggleBtn.querySelector('small');

        if (isExpanded) {
            icon.className = 'fas fa-chevron-down';
            text.innerHTML = '<i class="fas fa-chevron-down"></i> Show all';
        } else {
            icon.className = 'fas fa-chevron-up';
            text.innerHTML = '<i class="fas fa-chevron-up"></i> Show less';
        }
    }
</script>
{% endblock %}
